<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æ—¥ç³»æ¥µç°¡é¢¨æ—…éŠè¡Œç¨‹è¦åŠƒå™¨ - è˜‡æ­æ°´é„‰</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- è¼‰å…¥ Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lake-green': '#00ADB5',
                        'mint-light': '#B2EBF2',
                        'accent': '#39AEA9',
                        'money-gold': '#F59E0B', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'Microsoft JhengHei', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #f7f7f7; }
        .modal-overlay { background-color: rgba(255, 255, 255, 0.95); }
        .loading-overlay { background-color: rgba(255, 255, 255, 0.8); }
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-enter-active .modal-container, .modal-leave-active .modal-container { transition: all 0.3s ease; }
        .modal-enter-from .modal-container, .modal-leave-to .modal-container { transform: scale(0.9); }
        .bottom-nav-shadow { box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        /* å±•é–‹å‹•ç•« */
        .expand-enter-active, .expand-leave-active { transition: all 0.3s ease; max-height: 200px; opacity: 1; overflow: hidden; }
        .expand-enter-from, .expand-leave-to { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; }
        
        /* iPhone å®‰å…¨å€åŸŸè¨­å®š (ç€æµ·/å‹•æ…‹å³¶èˆ‡åº•éƒ¨æ©«æ¢) */
        .pb-safe { 
            padding-bottom: constant(safe-area-inset-bottom); /* iOS 11.0 */
            padding-bottom: env(safe-area-inset-bottom); /* iOS 11.2+ */
        }
        .pt-safe {
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
        }
    </style>
</head>
<body>

<div id="app" class="font-sans pb-32">

    <!-- è¼‰å…¥ä¸­ç•«é¢ -->
    <div v-if="isLoading" class="fixed inset-0 flex items-center justify-center z-50 loading-overlay">
        <div class="p-6 rounded-xl bg-white shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-lake-green mb-3"></div>
            <p class="text-gray-700 font-semibold">æ­£åœ¨å¾é›²ç«¯åŒæ­¥...</p>
        </div>
    </div>
    
    <!-- 1. é ‚éƒ¨å°èˆªèˆ‡æ¨™é¡Œ -->
    <header class="sticky top-0 z-20 bg-white shadow-sm p-4 border-b border-gray-100 pt-safe">
        <div class="flex items-center justify-center relative">
            <h1 class="text-xl font-bold text-gray-800">è˜‡æ­æ°´é„‰ 7 æ—¥æ”»ç•¥</h1>
            <span v-if="syncStatus === 'saving'" class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 animate-pulse">å„²å­˜ä¸­...</span>
            <span v-else-if="syncStatus === 'saved'" class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">å·²åŒæ­¥</span>
            <span v-else-if="syncStatus === 'error'" @click="forceUpdate" class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800 cursor-pointer">åŒæ­¥éŒ¯èª¤ ğŸš¨</span>
        </div>
        <p class="text-xs text-center text-gray-500 mt-1">æ—¥ç³»æ¥µç°¡é¢¨è¦åŠƒå™¨ | {{ currentDay.title }}</p>
    </header>

    <!-- 2. æ©«å‘æ—¥æœŸé¸å–® -->
    <nav class="sticky top-[72px] z-10 bg-white shadow-md">
        <div class="flex overflow-x-auto hide-scrollbar py-3 px-2">
            <div v-for="day in itinerary" :key="day.day" @click="setCurrentDate(day.day)"
                :class="{'bg-lake-green text-white shadow-lg': currentDate === day.day, 'bg-gray-100 text-gray-700 hover:bg-gray-200': currentDate !== day.day}"
                class="flex-shrink-0 mx-1 p-3 rounded-xl cursor-pointer transition-all duration-300 min-w-[100px] text-center"
            >
                <div class="text-xs font-semibold">{{ day.date }}</div>
                <div class="text-sm font-bold">{{ day.city }}</div>
            </div>
        </div>
    </nav>

    <!-- 3. è¡Œç¨‹åˆ—è¡¨ -->
    <main class="p-4 pt-6" :class="{ 'opacity-50 pointer-events-none': isLoading }">
        <!-- å¤©æ°£èˆ‡è­¦å‘Šå€å¡Š -->
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6 border-b-4 border-lake-green">
            <div class="flex items-center text-lg font-bold text-gray-800">
                <svg class="w-5 h-5 mr-2 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
                {{ currentDay.city }}
            </div>
            <div class="flex items-center text-md font-extrabold text-red-600 bg-mint-light px-3 py-1 rounded-full">
                <span v-html="getWeatherIcon(currentDay.weather)" class="mr-1"></span>
                {{ currentDay.weather }} / {{ currentDay.temp }}
            </div>
        </div>

        <div v-if="currentDay.cnyWarning" :class="currentDay.day >= 2 && currentDay.day <= 6 ? 'bg-red-50 border-red-300 text-red-800' : 'bg-yellow-50 border-yellow-300 text-yellow-800'" class="p-3 border rounded-xl mb-6 flex items-start text-sm transition-colors duration-300">
            <strong class="block mb-1 mr-2 text-red-900 shrink-0">âš ï¸ æ³¨æ„:</strong>
            <span v-html="currentDay.cnyWarning.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')"></span>
        </div>

        <!-- è¡Œç¨‹å¡ç‰‡ Loop -->
        <div v-for="(item, index) in currentDay.schedule" :key="index" class="bg-white rounded-xl shadow-lg mb-6 p-4 transition-all duration-300 hover:shadow-xl border-l-4 border-lake-green">
            <!-- å¡ç‰‡æœ¬é«” -->
            <div class="flex items-start mb-3">
                <div class="flex-shrink-0 mr-4 pt-1"><span v-html="getScheduleIcon(item.type)" class="text-2xl leading-none"></span></div>
                <div class="flex-grow">
                    <div class="text-sm font-bold text-accent mb-1">{{ item.time }}</div>
                    <div class="text-lg font-extrabold text-gray-800">{{ item.item }}</div>
                    <p class="text-xs text-gray-500 mt-1">{{ item.detail }}</p>
                </div>
                <div class="flex-shrink-0 text-right ml-4 pt-1">
                    <div class="text-sm font-semibold text-gray-700 flex items-center justify-end">
                        <span class="text-red-600">{{ formatCost(item.cost) }}</span>
                    </div>
                </div>
            </div>
            
            <!-- æŒ‰éˆ•åˆ— -->
            <div class="flex justify-start space-x-2 border-t pt-3 mt-3 overflow-x-auto hide-scrollbar">
                <button @click="editItem(currentDay.day, index)" class="flex-shrink-0 flex items-center px-3 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors text-xs font-bold whitespace-nowrap">ç·¨è¼¯</button>
                <button @click="deleteItem(currentDay.day, index)" class="flex-shrink-0 flex items-center px-3 py-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors text-xs font-bold whitespace-nowrap">åˆªé™¤</button>
                <button @click="openMap(item.location ? item.location.name : item.item)" class="flex-shrink-0 flex items-center px-3 py-2 rounded-lg bg-lake-green text-white hover:bg-accent transition-colors text-xs font-bold whitespace-nowrap">å°èˆª</button>
                
                <!-- ä¿®æ­£ï¼šå»ºè­°æŒ‰éˆ•ï¼Œå·²å¥—ç”¨æ‚¨çš„ API Key -->
                <button @click="generateSuggestion(currentDay.day, index)" :disabled="isGenerating" class="flex-shrink-0 flex items-center px-3 py-2 rounded-lg bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition-colors text-xs font-bold whitespace-nowrap disabled:opacity-50">âœ¨ å»ºè­°</button>
                
                <!-- ä¼¸ç¸®æŒ‡å—æŒ‰éˆ• -->
                <button @click="toggleGuide(item)" class="flex-shrink-0 flex items-center px-3 py-2 rounded-lg border border-money-gold text-money-gold hover:bg-yellow-50 transition-colors text-xs font-bold whitespace-nowrap ml-auto">
                    {{ item.isGuideOpen ? 'æ”¶èµ·æŒ‡å—' : 'ğŸšŒ æŒ‡å—' }}
                </button>
            </div>

            <!-- æ–°å¢ï¼šä¼¸ç¸®äº¤é€šæŒ‡å—å°è©±æ¡† -->
            <transition name="expand">
                <div v-if="item.isGuideOpen" class="mt-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200 text-sm text-gray-700 relative">
                    <div class="absolute -top-2 right-4 w-4 h-4 bg-yellow-50 border-t border-l border-yellow-200 transform rotate-45"></div>
                    <h4 class="font-bold text-money-gold mb-2 flex items-center">
                        <span class="mr-1">ğŸ’¡</span> äº¤é€šèˆ‡æ³¨æ„äº‹é …
                    </h4>
                    <div class="space-y-2">
                        <p><strong>ğŸš• æ­ä¹˜å»ºè­°ï¼š</strong>{{ getTransportTip(item.type) }}</p>
                    </div>
                </div>
            </transition>
        </div>
        
        <!-- ç©ºè¡Œç¨‹æç¤º -->
        <div v-if="currentDay.schedule.length === 0" class="text-center text-gray-400 py-10">
            é»æ“Šä¸‹æ–¹ã€Œ+ã€æ–°å¢è¡Œç¨‹
        </div>
    </main>

    <!-- 4. åº•éƒ¨åŠŸèƒ½å°èˆªåˆ— -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 bottom-nav-shadow z-30 pb-safe">
        <div class="flex justify-around items-end px-4 py-2">
            
            <!-- æŒ‡å—æŒ‰éˆ• (å·¦ - ç¸½è¦½) -->
            <button @click="isGuideModalOpen = true" class="flex flex-col items-center justify-center space-y-1 w-20 text-gray-500 hover:text-lake-green transition-colors pb-1 active:scale-95 duration-200">
                <span class="text-2xl">ğŸ“‹</span>
                <span class="text-[10px] font-bold">ç¸½è¦½æŒ‡å—</span>
            </button>

            <!-- æ–°å¢è¡Œç¨‹æŒ‰éˆ• (ä¸­) -->
            <button @click="openAddItemModal" class="flex flex-col items-center justify-center -mt-8 group">
                <div class="w-16 h-16 bg-lake-green rounded-full flex items-center justify-center shadow-lg border-4 border-gray-50 group-hover:scale-105 transition-transform group-active:scale-95">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                </div>
                <span class="text-[10px] font-bold text-gray-500 mt-1">æ–°å¢è¡Œç¨‹</span>
            </button>

            <!-- åˆ†å¸³æŒ‰éˆ• (å³) -->
            <button @click="isBillModalOpen = true" class="flex flex-col items-center justify-center space-y-1 w-20 text-gray-500 hover:text-money-gold transition-colors pb-1 active:scale-95 duration-200">
                <span class="text-2xl">ğŸ’°</span>
                <span class="text-[10px] font-bold">åˆ†å¸³ç³»çµ±</span>
            </button>
            
        </div>
    </div>

    <!-- Modals (ä¿æŒåŠŸèƒ½ä¸è®Š) -->
    <!-- 5. è¡Œç¨‹ç·¨è¼¯ Modal -->
    <transition name="modal">
        <div v-if="isModalOpen" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay backdrop-blur-sm">
            <div class="bg-white w-11/12 sm:w-96 p-6 rounded-2xl shadow-2xl transform transition-all duration-300 scale-100 border-t-8 border-lake-green modal-container">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">{{ editingItem.originalIndex !== null ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <form @submit.prevent="saveItem" class="space-y-4">
                    <input v-model="editingItem.time" type="text" class="block w-full border border-gray-300 rounded-lg p-3 focus:border-lake-green focus:ring-1 focus:ring-lake-green outline-none" placeholder="æ™‚é–“ (å¦‚: 14:00)">
                    <input v-model="editingItem.item" type="text" class="block w-full border border-gray-300 rounded-lg p-3 focus:border-lake-green focus:ring-1 focus:ring-lake-green outline-none" placeholder="åœ°é» / æ´»å‹•åç¨±">
                    <textarea v-model="editingItem.detail" rows="2" class="block w-full border border-gray-300 rounded-lg p-3 focus:border-lake-green focus:ring-1 focus:ring-lake-green outline-none" placeholder="ç´°ç¯€æè¿°"></textarea>
                    <input v-model="editingItem.cost" type="text" class="block w-full border border-gray-300 rounded-lg p-3 focus:border-lake-green focus:ring-1 focus:ring-lake-green outline-none" placeholder="è²»ç”¨ (äººæ°‘å¹£)">
                    <div class="flex justify-between pt-4">
                        <button type="button" @click="isModalOpen = false" class="w-1/2 py-3 mr-2 rounded-lg border border-gray-300 hover:bg-gray-100 text-gray-600 font-bold">å–æ¶ˆ</button>
                        <button type="submit" class="w-1/2 py-3 ml-2 rounded-lg text-white bg-lake-green hover:bg-accent font-bold">å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </transition>

    <!-- 6. LLM å»ºè­° Modal -->
    <transition name="modal">
        <div v-if="isSuggestionModalOpen" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay backdrop-blur-sm">
            <div class="bg-white w-11/12 sm:w-5/6 lg:w-1/2 max-h-[80vh] overflow-y-auto p-6 rounded-2xl shadow-2xl transform transition-all scale-100 border-t-8 border-yellow-500 modal-container">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ğŸ’¡ {{ generatingItemName }} çš„æ›¿ä»£æ–¹æ¡ˆ</h3>
                <div v-if="suggestionResult.text" class="prose max-w-none mb-6">
                    <div v-html="renderMarkdown(suggestionResult.text)" class="text-gray-700"></div>
                    <div v-if="suggestionResult.sources.length" class="mt-4 pt-4 border-t text-xs text-gray-500">
                        <p class="font-semibold">ä¾†æº:</p>
                        <ul class="list-disc list-inside"><li v-for="source in suggestionResult.sources"><a :href="source.uri" target="_blank" class="text-accent">{{ source.title }}</a></li></ul>
                    </div>
                </div>
                <div v-else class="text-center py-6 text-gray-500"><span class="animate-spin inline-block mr-2">ğŸ”„</span> è¼‰å…¥ä¸­...</div>
                <button @click="isSuggestionModalOpen = false" class="w-full py-3 rounded-lg text-white bg-yellow-600 hover:bg-yellow-700 font-bold">é—œé–‰</button>
            </div>
        </div>
    </transition>

    <!-- 7. äº¤é€šæŒ‡å— Modal (ç¸½è¦½) -->
    <transition name="modal">
        <div v-if="isGuideModalOpen" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay backdrop-blur-sm">
            <div class="bg-white w-11/12 sm:w-5/6 lg:w-1/2 max-h-[90vh] overflow-y-auto p-6 rounded-2xl shadow-2xl transform transition-all scale-100 border-t-8 border-accent modal-container">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ğŸ—ºï¸ æ˜¥ç¯€äº¤é€šæŒ‡å—èˆ‡è­¦å‘Šç¸½è¦½</h3>
                <div class="space-y-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <h4 class="font-bold text-lake-green mb-2">äº¤é€šæŒ‡å¼•</h4>
                        <ul class="list-disc list-inside text-sm text-gray-700"><li v-for="t in guideSummary.transport"><strong>Day {{ t.day }}:</strong> {{ t.item }} ({{ t.time }}) <span class="text-red-500">({{ formatCost(t.cost) }})</span></li></ul>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                        <h4 class="font-bold text-red-700 mb-2">æ˜¥ç¯€è­¦å‘Š</h4>
                        <ul class="list-disc list-inside text-sm text-red-800"><li v-for="w in guideSummary.warnings"><strong>{{ w.day }} ({{ w.city }}):</strong> {{ w.text }}</li></ul>
                    </div>
                </div>
                <button @click="isGuideModalOpen = false" class="w-full py-3 rounded-lg text-white bg-lake-green hover:bg-accent font-bold">ç­è§£</button>
            </div>
        </div>
    </transition>

    <!-- 8. ğŸ’° åˆ†å¸³ç³»çµ± Modal -->
    <transition name="modal">
        <div v-if="isBillModalOpen" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay backdrop-blur-sm">
            <div class="bg-white w-11/12 sm:w-full lg:w-2/3 h-[90vh] overflow-hidden flex flex-col rounded-2xl shadow-2xl transform transition-all scale-100 border-t-8 border-money-gold modal-container">
                
                <!-- Header -->
                <div class="p-4 border-b flex justify-between items-center bg-yellow-50">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <span class="mr-2">ğŸ’´</span> åˆ†å¸³å°å¹«æ‰‹
                    </h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">åŒ¯ç‡: 1 RMB =</span>
                        <input type="number" v-model.number="appSettings.exchangeRate" @change="saveAllData" class="w-16 border rounded px-1 text-sm text-center" step="0.01">
                        <span class="text-xs text-gray-500">TWD</span>
                        <button @click="isBillModalOpen = false" class="ml-2 text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex border-b bg-white">
                    <button @click="billTab = 'list'" :class="{'text-money-gold border-b-2 border-money-gold bg-yellow-50': billTab === 'list'}" class="flex-1 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50">è¨˜å¸³åˆ—è¡¨</button>
                    <button @click="billTab = 'settle'" :class="{'text-money-gold border-b-2 border-money-gold bg-yellow-50': billTab === 'settle'}" class="flex-1 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50">çµç®—å ±å‘Š ğŸ“Š</button>
                    <button @click="billTab = 'members'" :class="{'text-money-gold border-b-2 border-money-gold bg-yellow-50': billTab === 'members'}" class="flex-1 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50">æˆå“¡ç®¡ç† ğŸ‘¥</button>
                </div>

                <!-- Body (Scrollable) -->
                <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
                    
                    <!-- Tab 1: è¨˜å¸³åˆ—è¡¨ -->
                    <div v-if="billTab === 'list'">
                        <!-- æ–°å¢æ¶ˆè²»è¡¨å–® -->
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-yellow-200">
                            <h4 class="font-bold text-gray-700 mb-3 text-sm">â• æ–°å¢æ¶ˆè²»</h4>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <input v-model="newExpense.item" placeholder="é …ç›® (å¦‚: æ™šé¤)" class="border rounded p-2 text-sm w-full">
                                <div class="relative">
                                    <input v-model.number="newExpense.amountCNY" type="number" placeholder="é‡‘é¡ (RMB)" class="border rounded p-2 text-sm w-full">
                                    <span class="absolute right-2 top-2 text-xs text-gray-400">â‰ˆ {{ Math.round(newExpense.amountCNY * appSettings.exchangeRate) }} TWD</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="block text-xs text-gray-500 mb-1">ä»˜æ¬¾äºº:</label>
                                <select v-model="newExpense.payer" class="border rounded p-2 text-sm w-full bg-white">
                                    <option v-for="m in members" :value="m">{{ m }}</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="block text-xs text-gray-500 mb-1">åˆ†æ”¤äºº (é»æ“Šé¸æ“‡):</label>
                                <div class="flex flex-wrap gap-2">
                                    <span v-for="m in members" @click="toggleInvolved(m)" 
                                          :class="newExpense.involved.includes(m) ? 'bg-money-gold text-white' : 'bg-gray-200 text-gray-600'"
                                          class="px-3 py-1 rounded-full text-xs cursor-pointer select-none transition-colors border border-gray-300">
                                        {{ m }}
                                    </span>
                                </div>
                            </div>
                            <button @click="addExpense" class="w-full py-2 bg-money-gold text-white rounded-lg font-bold shadow hover:bg-yellow-600">æ–°å¢é€™ç­†æ¶ˆè²»</button>
                        </div>

                        <!-- æ¶ˆè²»åˆ—è¡¨ -->
                        <div v-if="expenses.length === 0" class="text-center text-gray-400 py-10">é‚„æ²’æœ‰æ¶ˆè²»ç´€éŒ„</div>
                        <div v-else class="space-y-3 pb-4">
                            <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-gray-300 flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-gray-800">{{ exp.item }}</div>
                                    <div class="text-xs text-gray-500">
                                        <span class="font-semibold text-money-gold">{{ exp.payer }}</span> å…ˆä»˜ï¼Œ
                                        {{ exp.involved.join(', ') }} åˆ†æ”¤
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-lg text-gray-800">Â¥{{ exp.amountCNY }}</div>
                                    <div class="text-xs text-gray-400">â‰ˆ NT$ {{ Math.round(exp.amountCNY * appSettings.exchangeRate) }}</div>
                                    <button @click="deleteExpense(idx)" class="text-xs text-red-400 underline mt-1">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: çµç®—å ±å‘Š -->
                    <div v-if="billTab === 'settle'">
                        <div class="bg-white p-5 rounded-xl shadow-md">
                            <h4 class="font-bold text-center text-gray-800 mb-4 border-b pb-2">ğŸ§® æœ€çµ‚çµç®— (ä»¥å°å¹£è¨ˆç®—)</h4>
                            
                            <div v-if="settlementPlan.length === 0" class="text-center text-gray-500 py-4">ç›®å‰æ²’æœ‰éœ€è¦çµç®—çš„å¸³å‹™ ğŸ‰</div>
                            
                            <div v-else class="space-y-4">
                                <div v-for="(trans, idx) in settlementPlan" :key="idx" class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                                    <div class="flex items-center">
                                        <span class="font-bold text-red-600">{{ trans.from }}</span>
                                        <span class="mx-2 text-gray-400 text-xs">â” çµ¦ â”</span>
                                        <span class="font-bold text-green-700">{{ trans.to }}</span>
                                    </div>
                                    <div class="font-extrabold text-lg text-gray-800">
                                        NT$ {{ trans.amount }}
                                    </div>
                                </div>
                                <p class="text-xs text-center text-gray-400 mt-4">å·²è‡ªå‹•å°‡äººæ°‘å¹£ä¾åŒ¯ç‡ {{ appSettings.exchangeRate }} æ›ç®—ç‚ºå°å¹£</p>
                            </div>

                            <!-- å€‹äººæ”¶æ”¯è©³æƒ… -->
                            <div class="mt-8 pt-4 border-t">
                                <h5 class="text-sm font-bold text-gray-600 mb-3">å€‹äººæ”¶æ”¯æ˜ç´° (RMB):</h5>
                                <div v-for="(bal, name) in balancesCNY" :key="name" class="flex justify-between text-sm py-1 border-b border-dashed">
                                    <span>{{ name }}</span>
                                    <span :class="bal > 0 ? 'text-green-600' : (bal < 0 ? 'text-red-600' : 'text-gray-400')">
                                        {{ bal > 0 ? 'æ‡‰æ”¶' : (bal < 0 ? 'æ‡‰ä»˜' : 'å¹³') }} Â¥{{ Math.abs(bal).toFixed(1) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 3: æˆå“¡ç®¡ç† -->
                    <div v-if="billTab === 'members'">
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <h4 class="font-bold text-gray-700 mb-3">ç®¡ç†æ—…ä¼´</h4>
                            <div class="flex space-x-2 mb-4">
                                <input v-model="newMemberName" placeholder="è¼¸å…¥åå­—" class="border rounded p-2 flex-grow">
                                <button @click="addMember" class="bg-lake-green text-white px-4 rounded font-bold">æ–°å¢</button>
                            </div>
                            <ul class="space-y-2">
                                <li v-for="(m, idx) in members" :key="idx" class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>{{ m }}</span>
                                    <button @click="removeMember(idx)" class="text-red-500 hover:text-red-700 text-sm" v-if="expenses.length === 0">ç§»é™¤</button>
                                    <span v-else class="text-xs text-gray-400">(å·²æœ‰å¸³å‹™ç„¡æ³•ç§»é™¤)</span>
                                </li>
                            </ul>
                            <p class="text-xs text-gray-400 mt-4">* ç‚ºäº†è³‡æ–™å®Œæ•´æ€§ï¼Œè‹¥è©²æˆå“¡å·²æœ‰æ¶ˆè²»ç´€éŒ„ï¼Œå‰‡ç„¡æ³•ç§»é™¤ã€‚</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed } = Vue;

    // ===========================================
    // é…ç½®
    // ===========================================
    const firebaseConfig = {
        apiKey: "AIzaSyAStFZD476TFwl7Q_6eYX8c4tPKLvR6cAk",
        authDomain: "linfamily-120ad.firebaseapp.com",
        projectId: "linfamily-120ad", 
        storageBucket: "linfamily-120ad.firebasestorage.app",
        messagingSenderId: "92686138706",
        appId: "1:92686138706:web:2846e8480a2c14f4c44e8b",
        measurementId: "G-N7PBTP6ZCS"
    };
    const geminiApiKey = "AIzaSyBETXcUXu-caIvK1Dr5ChMzkyUIRoy7zvA"; // æ‚¨çš„ API Key
    // ä¿®æ­£ï¼šä½¿ç”¨ gemini-2.5-flash-preview-09-2025ï¼Œé€™æ˜¯ç³»çµ±ç›®å‰æ”¯æ´çš„æ¨¡å‹
    const LLM_MODEL = "gemini-2.5-flash-preview-09-2025"; 

    // åˆå§‹æ•¸æ“š
    const fullItineraryData = [
        {
            day: 1, date: '2/15 (æ—¥)', city: 'ä¸Šæµ· â” è˜‡å·', title: 'å°åŒ— â” ä¸Šæµ· â” è˜‡å·', weather: 'å¤šé›²è½‰é™°', temp: '3Â°C ~ 8Â°C', cnyWarning: 'å±±å¡˜è¡—æ˜¥ç¯€ç‡ˆé£¾è±å¯Œï¼Œé™¤å¤•å¤œå°åƒå¤šä¼‘æ¯ã€‚',
            schedule: [
                { time: '14:40', item: 'å°åŒ— â” ä¸Šæµ·', detail: 'è™¹æ©‹ T1', cost: 0, type: 'plane' },
                { time: '19:00', item: 'é«˜éµ â” è˜‡å·', detail: 'ç´„ 35 åˆ†é˜', cost: 39.5, type: 'train', location: { name: 'è˜‡å·ç«™' } },
                { time: 'æ™šé–“', item: 'å±±å¡˜è¡—å¤œæ™¯', detail: 'æ»´æ»´å‰å¾€', cost: 20, type: 'local', location: { name: 'å±±å¡˜è¡—' } }
            ]
        },
        {
            day: 2, date: '2/16 (ä¸€)', city: 'è˜‡å·å¸‚å€', title: 'è˜‡å·å¸‚å€éŠ (é™¤å¤•)', weather: 'é™°å¤©', temp: '3Â°C ~ 7Â°C', cnyWarning: 'è˜‡åšéœ€æå‰7å¤©é ç´„ï¼Œé™¤å¤•æ™¯é»ææ—©é—œé–€ã€‚',
            schedule: [
                { time: '08:30', item: 'æ‹™æ”¿åœ’ / è˜‡åš', detail: 'éœ€é ç´„', cost: 70, type: 'attraction', location: { name: 'æ‹™æ”¿åœ’' } },
                { time: '13:00', item: 'å¹³æ±Ÿè·¯', detail: 'æ¼«æ­¥è€è¡—', cost: 0, type: 'attraction', location: { name: 'å¹³æ±Ÿè·¯' } },
                { time: 'æ™šé–“', item: 'å¹´å¤œé£¯', detail: 'é£¯åº—å…§ç”¨é¤', cost: 500, type: 'food' }
            ]
        },
        {
            day: 3, date: '2/17 (äºŒ)', city: 'è˜‡å·å¸‚å€', title: 'è˜‡å·å¸‚å€éŠ (åˆä¸€)', weather: 'å¤šé›²', temp: '4Â°C ~ 9Â°C', cnyWarning: 'å¯’å±±å¯ºäººæµç®¡åˆ¶ï¼Œæ¨è–¦å»è™ä¸˜ã€‚',
            schedule: [
                { time: '09:00', item: 'è™ä¸˜', detail: 'å³ä¸­ç¬¬ä¸€å±±', cost: 60, type: 'attraction', location: { name: 'è™ä¸˜' } },
                { time: '14:00', item: 'é‡‘é›æ¹–', detail: 'ç¾ä»£åŒ–æ™¯å€', cost: 0, type: 'attraction', location: { name: 'é‡‘é›æ¹–' } }
            ]
        },
        { day: 4, date: '2/18 (ä¸‰)', city: 'è˜‡å· â” çƒé®', title: 'å‰å¾€æ°´é„‰çƒé®', weather: 'å°é›¨', temp: '2-6Â°C', cnyWarning: 'çƒé®æ–æ«“èˆ¹æ’éšŠä¹…ã€‚', schedule: [{ time: '10:00', item: 'åŒ…è»Šå»çƒé®', detail: 'ç´„1.5hr', cost: 600, type: 'car' }, { time: 'ä¸‹åˆ', item: 'è¥¿æŸµéŠè¦½', detail: 'å«å¤œæ™¯', cost: 150, type: 'attraction' }] },
        { day: 5, date: '2/19 (å››)', city: 'çƒé® â” æ­å·', title: 'å‰å¾€æ­å·', weather: 'å¤šé›²', temp: '4-10Â°C', cnyWarning: 'è¥¿æ¹–äº¤ç®¡åš´æ ¼ã€‚', schedule: [{ time: '11:00', item: 'å¤§å·´å»æ­å·', detail: 'è‡³æ­å·æ±', cost: 50, type: 'bus' }, { time: 'ä¸‹åˆ', item: 'è¥¿æ¹–æ¼«æ­¥', detail: 'ç’°æ¹–', cost: 0, type: 'attraction' }] },
        { day: 6, date: '2/20 (äº”)', city: 'æ­å·', title: 'åƒå³¶æ¹–æˆ–å¸‚å€', weather: 'æ™´', temp: '5-12Â°C', cnyWarning: 'åƒå³¶æ¹–èˆ¹ç¥¨éœ€æ¶ã€‚', schedule: [{ time: '09:00', item: 'åƒå³¶æ¹–/éˆéš±å¯º', detail: 'ä¸€æ—¥éŠ', cost: 200, type: 'attraction' }] },
        { day: 7, date: '2/21 (å…­)', city: 'è¿”ç¨‹', title: 'æ­å· â” ä¸Šæµ· â” å°åŒ—', weather: 'å¤šé›²', temp: '6-10Â°C', cnyWarning: 'è¿”ç¨‹é«˜å³°é ç•™æ™‚é–“ã€‚', schedule: [{ time: '15:21', item: 'é«˜éµå»è™¹æ©‹', detail: '47åˆ†', cost: 73, type: 'train' }, { time: '19:40', item: 'é£›å°åŒ—', detail: 'T2', cost: 0, type: 'plane' }] }
    ];

    // åˆå§‹åŒ– Firebase
    let db, itineraryRef;
    try {
        const app = firebase.initializeApp(firebaseConfig);
        db = app.firestore();
        itineraryRef = db.collection("itineraries").doc("sugangTrip");
    } catch (e) { console.error("Firebase Init Error", e); }

    createApp({
        setup() {
            const currentDate = ref(1);
            const itinerary = ref([]);
            const isLoading = ref(true);
            const syncStatus = ref('saved');
            const isModalOpen = ref(false);
            const editingItem = ref({ time: '', item: '', detail: '', cost: '', type: 'local', originalDay: null, originalIndex: null });
            
            // LLM
            const suggestionResult = ref({ text: '', sources: [] });
            const isGenerating = ref(false);
            const isSuggestionModalOpen = ref(false);
            const generatingItemName = ref('');
            
            // æŒ‡å—
            const isGuideModalOpen = ref(false);

            // === ğŸ’° åˆ†å¸³ç³»çµ±ç‹€æ…‹ ===
            const isBillModalOpen = ref(false);
            const billTab = ref('list'); // 'list', 'settle', 'members'
            const members = ref(['æˆ‘', 'æ—…ä¼´A']); // é è¨­æˆå“¡
            const newMemberName = ref('');
            const appSettings = ref({ exchangeRate: 4.45 }); // é è¨­åŒ¯ç‡
            const expenses = ref([]); // { item, amountCNY, payer, involved: [] }
            const newExpense = ref({ item: '', amountCNY: '', payer: 'æˆ‘', involved: [] });

            // ----------------------------------------------------
            // é‹ç®—é‚è¼¯
            // ----------------------------------------------------
            const currentDay = computed(() => itinerary.value.find(day => day.day === currentDate.value) || { schedule: [] });

            const guideSummary = computed(() => {
                const transport = [];
                const warnings = [];
                itinerary.value.forEach(day => {
                    day.schedule.forEach(item => {
                        if (['plane', 'train', 'bus', 'car'].includes(item.type)) {
                            transport.push({ day: day.day, item: item.item, time: item.time, cost: item.cost });
                        }
                    });
                    if (day.cnyWarning) warnings.push({ day: day.date, city: day.city, text: day.cnyWarning });
                });
                return { transport, warnings };
            });

            // åˆ†å¸³æ ¸å¿ƒé‚è¼¯
            const balancesCNY = computed(() => {
                let bal = {};
                members.value.forEach(m => bal[m] = 0);
                expenses.value.forEach(exp => {
                    const amount = parseFloat(exp.amountCNY);
                    if (!amount || exp.involved.length === 0) return;
                    
                    // ä»˜æ¬¾äºº +amount
                    if (bal[exp.payer] === undefined) bal[exp.payer] = 0;
                    bal[exp.payer] += amount;

                    // åˆ†æ”¤äºº -average
                    const splitAmount = amount / exp.involved.length;
                    exp.involved.forEach(person => {
                        if (bal[person] === undefined) bal[person] = 0;
                        bal[person] -= splitAmount;
                    });
                });
                return bal;
            });

            const settlementPlan = computed(() => {
                let debtors = [];
                let creditors = [];
                const rate = appSettings.value.exchangeRate;

                for (const [person, amountCNY] of Object.entries(balancesCNY.value)) {
                    // é€™è£¡å››æ¨äº”å…¥åˆ°å°æ•¸é»2ä½é¿å…æµ®é»æ•¸èª¤å·®
                    const amount = Math.round(amountCNY * 100) / 100;
                    if (amount < -0.01) debtors.push({ person, amount });
                    if (amount > 0.01) creditors.push({ person, amount });
                }

                debtors.sort((a, b) => a.amount - b.amount); // æ¬ æœ€å¤šéŒ¢çš„åœ¨å‰é¢
                creditors.sort((a, b) => b.amount - a.amount); // å€Ÿå‡ºæœ€å¤šçš„åœ¨å‰é¢

                let transactions = [];
                let i = 0; // debtors index
                let j = 0; // creditors index

                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];

                    // å–çµ•å°å€¼æ¯”è¼ƒï¼Œçœ‹æ˜¯é‚„æ¸…å‚µå‹™é‚„æ˜¯æ”¶å›å‚µæ¬Š
                    let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                    
                    // æ›ç®—å°å¹£ä¸¦å–æ•´
                    let amountTWD = Math.round(amount * rate);

                    if (amountTWD > 0) {
                        transactions.push({
                            from: debtor.person,
                            to: creditor.person,
                            amount: amountTWD
                        });
                    }

                    // æ›´æ–°é¤˜é¡
                    debtor.amount += amount;
                    creditor.amount -= amount;

                    // å¦‚æœå‚µå‹™äººé‚„æ¸…äº†ï¼Œæ›ä¸‹ä¸€å€‹
                    if (Math.abs(debtor.amount) < 0.01) i++;
                    // å¦‚æœå‚µæ¬Šäººæ”¶å®Œäº†ï¼Œæ›ä¸‹ä¸€å€‹
                    if (creditor.amount < 0.01) j++;
                }
                return transactions;
            });

            // ----------------------------------------------------
            // å‹•ä½œ
            // ----------------------------------------------------
            const saveAllData = async () => {
                if (!itineraryRef) return;
                syncStatus.value = 'saving';
                try {
                    // å„²å­˜å®Œæ•´è³‡æ–™çµæ§‹
                    const payload = JSON.parse(JSON.stringify({
                        itinerary: itinerary.value,
                        expenses: expenses.value,
                        members: members.value,
                        settings: appSettings.value
                    }));
                    await itineraryRef.set({ data: payload, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    syncStatus.value = 'saved';
                } catch (e) {
                    console.error(e);
                    syncStatus.value = 'error';
                }
            };

            const forceUpdate = () => saveAllData();

            // æ–°å¢åŠŸèƒ½: åˆ‡æ›å¡ç‰‡å…§çš„æŒ‡å—
            const toggleGuide = (item) => {
                // å¦‚æœ isGuideOpen ä¸å­˜åœ¨ï¼ŒVue æœƒè‡ªå‹•åæ‡‰
                item.isGuideOpen = !item.isGuideOpen;
                // æ³¨æ„ï¼šé€™è£¡ä¸å‘¼å« saveAllDataï¼Œå› ç‚ºé€™æ˜¯ UI ç‹€æ…‹ï¼Œä¸éœ€è¦åŒæ­¥åˆ°è³‡æ–™åº«
            };

            // æ–°å¢åŠŸèƒ½: å–å¾—äº¤é€šæç¤ºæ–‡å­—
            const getTransportTip = (type) => {
                switch(type) {
                    case 'plane': return 'æ˜¥ç¯€æ©Ÿå ´äººæ½®çœ¾å¤šï¼Œå»ºè­°æå‰ 3 å°æ™‚æŠµé”æ©Ÿå ´è¾¦ç†ç™»æ©Ÿèˆ‡å®‰æª¢ã€‚';
                    case 'train': return 'é«˜éµç«™å®‰æª¢éšŠä¼è¼ƒé•·ï¼Œå»ºè­°æå‰ 60 åˆ†é˜æŠµé”è»Šç«™å–ç¥¨ã€‚';
                    case 'bus': return 'å®¢é‹ç«™å¯èƒ½æœƒæœ‰è‡¨æ™‚ç­æ¬¡èª¿æ•´ï¼Œå»ºè­°æå‰ 30 åˆ†é˜å€™è»Šã€‚';
                    case 'car': return 'æ˜¥ç¯€æœŸé–“é«˜é€Ÿå…¬è·¯æ˜“å£…å¡ï¼Œè«‹èˆ‡å¸æ©Ÿç¢ºèªè·¯ç·šä¸¦é ç•™å¯¬è£•æ™‚é–“ã€‚';
                    case 'attraction': return 'ç†±é–€æ™¯é»è«‹å‹™å¿…ç¢ºèªé ç´„æ™‚æ®µï¼Œå»ºè­°é¿é–‹å°–å³°æ™‚æ®µå…¥åœ’ã€‚';
                    case 'food': return 'ç”¨é¤é«˜å³°æ™‚æ®µéœ€æ’éšŠï¼Œå»ºè­°æå‰è¨‚ä½æˆ–é¿é–‹æ­£é¤æ™‚é–“ã€‚';
                    default: return 'æ˜¥ç¯€æœŸé–“äººæ½®çœ¾å¤šï¼Œè«‹æ³¨æ„éš¨èº«è²¡ç‰©å®‰å…¨ã€‚';
                }
            };

            // åˆ†å¸³å‹•ä½œ
            const addMember = () => {
                if (newMemberName.value && !members.value.includes(newMemberName.value)) {
                    members.value.push(newMemberName.value);
                    newMemberName.value = '';
                    saveAllData();
                }
            };
            const removeMember = (idx) => {
                members.value.splice(idx, 1);
                saveAllData();
            };
            const toggleInvolved = (name) => {
                const idx = newExpense.value.involved.indexOf(name);
                if (idx > -1) newExpense.value.involved.splice(idx, 1);
                else newExpense.value.involved.push(name);
            };
            const addExpense = () => {
                if (!newExpense.value.item || !newExpense.value.amountCNY || newExpense.value.involved.length === 0) {
                    alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š (é …ç›®ã€é‡‘é¡ã€åˆ†æ”¤äºº)");
                    return;
                }
                expenses.value.push({ ...newExpense.value });
                // Reset form
                newExpense.value = { item: '', amountCNY: '', payer: 'æˆ‘', involved: [...members.value] }; // é è¨­å…¨é¸
                saveAllData();
            };
            const deleteExpense = (idx) => {
                if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†å¸³å‹™?')) {
                    expenses.value.splice(idx, 1);
                    saveAllData();
                }
            };

            // è¡Œç¨‹å‹•ä½œ (åŒ…è£ saveAllData)
            const saveItem = () => {
                const dayData = itinerary.value.find(d => d.day === editingItem.value.originalDay);
                if (!dayData) { isModalOpen.value = false; return; }
                const newItem = { time: editingItem.value.time, item: editingItem.value.item, detail: editingItem.value.detail, cost: editingItem.value.cost, type: editingItem.value.type || 'local' };
                if (editingItem.value.originalIndex !== null) {
                    const existingItem = dayData.schedule[editingItem.value.originalIndex];
                    dayData.schedule[editingItem.value.originalIndex] = { ...(existingItem.location && { location: existingItem.location }), ...newItem };
                } else {
                    dayData.schedule.push(newItem);
                    dayData.schedule.sort((a, b) => (a.time > b.time) ? 1 : -1);
                }
                isModalOpen.value = false;
                saveAllData();
            };
            const deleteItem = (day, index) => {
                if (confirm('ç¢ºå®šåˆªé™¤?')) {
                    const dayData = itinerary.value.find(d => d.day === day);
                    if (dayData) {
                        dayData.schedule.splice(index, 1);
                        saveAllData();
                    }
                }
            };

            // Firebase ç›£è½
            if (itineraryRef) {
                itineraryRef.onSnapshot(doc => {
                    if (doc.exists && doc.data().data) {
                        const cloudData = doc.data().data;
                        // å…¼å®¹èˆŠè³‡æ–™çµæ§‹ (å¦‚æœé›²ç«¯åªå­˜äº† array)
                        if (Array.isArray(cloudData)) {
                            itinerary.value = cloudData;
                        } else {
                            // æ–°è³‡æ–™çµæ§‹
                            itinerary.value = cloudData.itinerary || fullItineraryData;
                            expenses.value = cloudData.expenses || [];
                            members.value = cloudData.members || ['æˆ‘', 'æ—…ä¼´A'];
                            appSettings.value = cloudData.settings || { exchangeRate: 4.45 };
                        }
                        syncStatus.value = 'saved';
                    } else {
                        itinerary.value = fullItineraryData;
                        saveAllData();
                    }
                    isLoading.value = false;
                    // åˆå§‹åŒ–æ–°å¢è¡¨å–®çš„åˆ†æ”¤äººç‚ºæ‰€æœ‰æˆå“¡
                    if (newExpense.value.involved.length === 0) newExpense.value.involved = [...members.value];
                }, err => {
                    console.error(err);
                    isLoading.value = false;
                    syncStatus.value = 'error';
                });
            } else { isLoading.value = false; itinerary.value = fullItineraryData; }

            // Utils
            const setCurrentDate = (d) => { currentDate.value = d; window.scrollTo({top:0, behavior:'smooth'}); };
            const openAddItemModal = () => { editingItem.value = { time: '', item: '', detail: '', cost: '', type: 'local', originalDay: currentDate.value, originalIndex: null }; isModalOpen.value = true; };
            const editItem = (day, index) => { 
                const d = itinerary.value.find(x => x.day === day);
                editingItem.value = { ...d.schedule[index], originalDay: day, originalIndex: index }; 
                delete editingItem.value.location; 
                isModalOpen.value = true; 
            };
            const openMap = (loc) => window.open(`https://www.google.com/maps/search/${loc}`, '_blank');
            const getWeatherIcon = (w) => w?.includes('é›¨') ? 'ğŸŒ§ï¸' : (w?.includes('é™°') ? 'â˜ï¸' : 'â˜€ï¸');
            const getScheduleIcon = (t) => ({plane:'âœˆï¸',train:'ğŸš„',bus:'ğŸšŒ',car:'ğŸš—',attraction:'ğŸ›ï¸',food:'ğŸ²'}[t] || 'ğŸ“');
            const formatCost = (c) => (c == 0 || c == '0') ? 'å…è²»' : `Â¥ ${c}`;
            
            // LLM (Simplified for brevity, ensure API Key is set if used)
            const renderMarkdown = (t) => t ? t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').split('\n').map(l=>l.startsWith('* ')?`<li>${l.slice(2)}</li>`:`<p>${l}</p>`).join('') : '';
            const generateSuggestion = async (day, index) => {
                if(!geminiApiKey) return alert('è«‹è¨­å®š API Key');
                isGenerating.value = true; 
                isSuggestionModalOpen.value = true; 
                suggestionResult.value.text = '';
                
                const item = itinerary.value.find(d=>d.day===day).schedule[index];
                generatingItemName.value = item.item;

                const systemPrompt = "You are a local travel expert in the Jiangsu and Zhejiang region (Suzhou, Hangzhou, Wuzhen, Shanghai). Your task is to provide three high-quality, actionable alternative suggestions or backup plans for a given itinerary item. The suggestions must be appropriate for a Chinese New Year (CNY) trip and consider the crowd warnings and weather provided. Respond concisely in Traditional Chinese, strictly as a bulleted list (use Markdown format: '*' for list items). Do not include an introduction, conclusion, or any extra text outside the bulleted list.";
                const userQuery = `Current City: ${itinerary.value.find(d => d.day === day).city}, Item: ${item.item} (${item.detail}). Generate 3 alternative suggestions.`;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${geminiApiKey}`;
                
                // ä¿®æ­£ï¼šæœ€å¤§å…¼å®¹æ¨¡å¼ï¼Œåˆä½µ system promptï¼Œç§»é™¤ tools
                const payload = { 
                    contents: [{ parts: [{ text: systemPrompt + "\n\n" + userQuery }] }]
                };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    
                    if (!response.ok) {
                        // ä¿®æ­£ï¼šé¡¯ç¤ºå…·é«” API éŒ¯èª¤åŸå› 
                        const errorMessage = result.error?.message || `HTTP Error: ${response.status}`;
                        throw new Error(`API éŒ¯èª¤: ${errorMessage}`);
                    }

                    if (result && result.candidates && result.candidates.length > 0) {
                        const candidate = result.candidates[0];
                        suggestionResult.value.text = candidate.content?.parts?.[0]?.text || 'æœªèƒ½ç”Ÿæˆå»ºè­°ã€‚';
                        suggestionResult.value.sources = candidate.groundingMetadata?.groundingAttributions?.map(a => ({ uri: a.web?.uri, title: a.web?.title })).filter(s => s.uri && s.title) || [];
                    } else {
                        if (result.promptFeedback && result.promptFeedback.blockReason) {
                             suggestionResult.value.text = `ç„¡æ³•å–å¾—å»ºè­°ï¼šå…§å®¹è¢«é˜»æ“‹ (${result.promptFeedback.blockReason})ã€‚`;
                        } else {
                             suggestionResult.value.text = 'ç„¡æ³•å–å¾—å»ºè­° (No candidates returned)ã€‚';
                        }
                    }
                } catch (e) {
                    console.error(e);
                    suggestionResult.value.text = `API éŒ¯èª¤: ${e.message}`;
                } finally {
                    isGenerating.value = false;
                }
            };

            return {
                currentDate, itinerary, currentDay, isLoading, syncStatus, isModalOpen, editingItem,
                isSuggestionModalOpen, suggestionResult, isGenerating, generatingItemName,
                isGuideModalOpen, guideSummary,
                // åˆ†å¸³ç›¸é—œ
                isBillModalOpen, billTab, members, newMemberName, expenses, newExpense, appSettings,
                balancesCNY, settlementPlan,
                // Actions
                setCurrentDate, openAddItemModal, editItem, saveItem, deleteItem, openMap, 
                getWeatherIcon, getScheduleIcon, formatCost, generateSuggestion, renderMarkdown,
                geminiApiKey, forceUpdate,
                addMember, removeMember, toggleInvolved, addExpense, deleteExpense, saveAllData,
                toggleGuide, getTransportTip // æ–°å¢
            };
        }
    }).mount('#app');
</script>
</body>
</html>
