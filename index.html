<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥ç³»æ¥µç°¡é¢¨æ—…éŠè¡Œç¨‹è¦åŠƒå™¨ - è˜‡æ­æ°´é„‰</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- ğŸŒŸ [é‡è¦æ–°å¢] è¼‰å…¥ Firebase SDK ä»¥å¯¦ç¾è·¨è¨­å‚™åŒæ­¥ -->
    <!-- æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨çš„æ˜¯å…¼å®¹ç‰ˆæœ¬ï¼Œä»¥ç¢ºä¿å»£æ³›çš„ç€è¦½å™¨æ”¯æ´ -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <!-- Tailwind é…ç½®ï¼šè¨­ç½®æ¹–æ°´ç¶ å’Œæ—¥ç³»æ¥µç°¡å­—é«” -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lake-green': '#00ADB5', // ä¸»æ¹–æ°´ç¶ 
                        'mint-light': '#B2EBF2', // æ·ºè‰²èƒŒæ™¯
                        'accent': '#39AEA9', // é»ç¶´è‰²
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'Microsoft JhengHei', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒæ»‘å‹•åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* App å°ˆç”¨èƒŒæ™¯ */
        body {
            background-color: #f7f7f7;
        }
        /* ç¢ºä¿ modal å±…ä¸­ä¸¦è¦†è“‹ä¸€åˆ‡ */
        .modal-overlay {
            background-color: rgba(255, 255, 255, 0.95);
        }
        .loading-overlay {
            background-color: rgba(255, 255, 255, 0.8);
        }
        /* Vue Transition æ•ˆæœ */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s ease;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }
        .modal-enter-active .modal-container,
        .modal-leave-active .modal-container {
            transition: all 0.3s ease;
        }
        .modal-enter-from .modal-container,
        .modal-leave-to .modal-container {
            transform: scale(0.9);
        }
    </style>
</head>
<body>

<div id="app" class="font-sans pb-20"> <!-- å¢åŠ åº•éƒ¨ padding ä»¥å®¹ç´æ–°å¢æŒ‰éˆ• -->

    <!-- ğŸŒŸ è¼‰å…¥ä¸­ç•«é¢ -->
    <div v-if="isLoading" class="fixed inset-0 flex items-center justify-center z-50 loading-overlay">
        <div class="p-6 rounded-xl bg-white shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-lake-green mb-3"></div>
            <p class="text-gray-700 font-semibold">æ­£åœ¨å¾é›²ç«¯åŒæ­¥æœ€æ–°çš„è¡Œç¨‹...</p>
        </div>
    </div>
    
    <!-- 1. é ‚éƒ¨å°èˆªèˆ‡æ¨™é¡Œ -->
    <header class="sticky top-0 z-20 bg-white shadow-sm p-4 border-b border-gray-100">
        <h1 class="text-xl font-bold text-gray-800 text-center">
            è˜‡æ­æ°´é„‰ 7 æ—¥æ˜¥ç¯€çµ‚æ¥µæ”»ç•¥
        </h1>
        <p class="text-xs text-center text-gray-500 mt-1">
            æ—¥ç³»æ¥µç°¡é¢¨è¦åŠƒå™¨ | {{ currentDay.title }}
        </p>
        <!-- äº¤é€šæŒ‡å—èˆ‡æ³¨æ„äº‹é …æŒ‰éˆ• -->
        <button @click="isGuideModalOpen = true"
            class="absolute right-4 top-1/2 -translate-y-1/2 p-2 rounded-lg bg-mint-light text-accent hover:bg-lake-green hover:text-white transition-colors text-xs font-semibold shadow-inner"
        >
            äº¤é€š/è­¦å‘ŠæŒ‡å— ğŸšŒ
        </button>
    </header>

    <!-- 2. æ©«å‘æ—¥æœŸé¸å–® (App æ¨£å¼) -->
    <nav class="sticky top-16 z-10 bg-white shadow-md">
        <div class="flex overflow-x-auto hide-scrollbar py-3 px-2">
            <div v-for="day in itinerary" :key="day.day"
                @click="setCurrentDate(day.day)"
                :class="{'bg-lake-green text-white shadow-lg': currentDate === day.day, 'bg-gray-100 text-gray-700 hover:bg-gray-200': currentDate !== day.day}"
                class="flex-shrink-0 mx-1 p-3 rounded-xl cursor-pointer transition-all duration-300 min-w-[100px] text-center"
            >
                <div class="text-xs font-semibold">{{ day.date }}</div>
                <div class="text-sm font-bold">{{ day.city }}</div>
            </div>
        </div>
    </nav>

    <!-- 3. è¡Œç¨‹åˆ—è¡¨ -->
    <main class="p-4 pt-6" :class="{ 'opacity-50 pointer-events-none': isLoading }">

        <!-- å¤©æ°£è³‡è¨Šèˆ‡åœ°é»ç¸½è¦½ -->
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6 border-b-4 border-lake-green">
            <div class="flex items-center text-lg font-bold text-gray-800">
                <svg class="w-5 h-5 mr-2 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
                {{ currentDay.city }}
            </div>
            <!-- å¤©æ°£é¡¯ç¤º -->
            <div class="flex items-center text-md font-extrabold text-red-600 bg-mint-light px-3 py-1 rounded-full">
                <span v-html="getWeatherIcon(currentDay.weather)" class="mr-1"></span>
                {{ currentDay.weather }} / {{ currentDay.temp }}
            </div>
        </div>

        <!-- æ˜¥ç¯€è­¦å‘Šå€å¡Š -->
        <div v-if="currentDay.cnyWarning" 
             :class="currentDay.day >= 2 && currentDay.day <= 6 ? 'bg-red-50 border-red-300 text-red-800' : 'bg-yellow-50 border-yellow-300 text-yellow-800'"
             class="p-3 border rounded-xl mb-6 flex items-start text-sm transition-colors duration-300"
        >
            <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            <div>
                <strong class="block mb-1 text-red-900">æ˜¥ç¯€æ™¯å€ç‰¹åˆ¥æ³¨æ„äº‹é …:</strong>
                <span v-html="currentDay.cnyWarning.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')"></span>
            </div>
        </div>

        <div v-if="!currentDay.schedule || currentDay.schedule.length === 0" class="text-center p-12 text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M10 12h.01"></path></svg>
            <p>ç•¶æ—¥è¡Œç¨‹å°šæœªè¦åŠƒï¼Œé»æ“Šä¸‹æ–¹æ–°å¢ã€‚</p>
        </div>

        <!-- è±å¯Œçš„è¡Œç¨‹å¡ç‰‡åˆ—è¡¨ (Loop over schedule) -->
        <div v-for="(item, index) in currentDay.schedule" :key="index"
            class="bg-white rounded-xl shadow-lg mb-6 p-4 transition-all duration-300 hover:shadow-xl border-l-4 border-lake-green"
        >
            <div class="flex items-start mb-3">
                <!-- æ™‚é–“èˆ‡åœ–ç¤º -->
                <div class="flex-shrink-0 mr-4 pt-1">
                    <span v-html="getScheduleIcon(item.type)" class="text-2xl leading-none"></span>
                </div>
                <!-- æ¨™é¡Œèˆ‡ç´°ç¯€ -->
                <div class="flex-grow">
                    <div class="text-sm font-bold text-accent mb-1">{{ item.time }}</div>
                    <div class="text-lg font-extrabold text-gray-800">{{ item.item }}</div>
                    <p class="text-xs text-gray-500 mt-1">{{ item.detail }}</p>
                </div>
                <!-- é ä¼°è²»ç”¨ -->
                <div class="flex-shrink-0 text-right ml-4 pt-1">
                    <div class="text-sm font-semibold text-gray-700 flex items-center justify-end">
                        <svg class="w-4 h-4 mr-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9H7m14 0c0-4.97-4.03-9-9-9S3 4.03 3 9h18zM3 15h18c0 4.97-4.03 9-9 9s-9-4.03-9-9z"></path></svg>
                        <span class="ml-1 text-red-600">{{ formatCost(item.cost) }}</span>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="flex justify-start space-x-2 border-t pt-3 mt-3">
                <!-- ç·¨è¼¯æŒ‰éˆ•ï¼šç¾åœ¨å‚³é day å’Œ index -->
                <button @click="editItem(currentDay.day, index)"
                    class="flex items-center p-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors text-sm"
                >
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-7l-4 4-2 2v4h4l2-2 4-4m-7-7l2 2m4 4l2 2"></path></svg>
                    ç·¨è¼¯
                </button>
                <!-- åˆªé™¤æŒ‰éˆ•ï¼šç¾åœ¨å‚³é day å’Œ index -->
                <button @click="deleteItem(currentDay.day, index)"
                    class="flex items-center p-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors text-sm"
                >
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    åˆªé™¤
                </button>
                <button @click="openMap(item.location ? item.location.name : item.item)"
                    class="flex items-center p-2 rounded-lg bg-lake-green text-white hover:bg-accent transition-colors text-sm"
                >
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    å°èˆª
                </button>
                
                <!-- AI å»ºè­°æŒ‰éˆ• -->
                <button @click="generateSuggestion(currentDay.day, index)"
                    :disabled="isGenerating || geminiApiKey === ''"
                    class="flex items-center p-2 rounded-lg bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition-colors text-sm disabled:opacity-50"
                    :title="geminiApiKey === '' ? 'è«‹è¨­å®š Gemini API Key ä»¥å•Ÿç”¨å»ºè­°åŠŸèƒ½' : ''"
                >
                    <span v-if="isGenerating" class="animate-spin mr-1">ğŸ”„</span>
                    <span v-else>âœ¨ æ›¿ä»£æ–¹æ¡ˆå»ºè­°</span>
                </button>
            </div>
        </div>
    </main>

    <!-- 4. æ–°å¢æŒ‰éˆ• (å›ºå®šåº•éƒ¨ App æ¨£å¼) -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-100 shadow-2xl z-20">
        <button @click="openAddItemModal"
            class="w-full py-3 rounded-xl text-white font-bold text-lg bg-lake-green hover:bg-accent transition-all duration-300 shadow-md"
        >
            + æ–°å¢è¡Œç¨‹
        </button>
    </div>

    <!-- 5. æ–°å¢/ç·¨è¼¯ Modal è¦–çª— -->
    <transition name="modal">
        <div v-if="isModalOpen" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay backdrop-blur-sm">
            <div class="bg-white w-11/12 sm:w-96 p-6 rounded-2xl shadow-2xl transform transition-all duration-300 scale-100 border-t-8 border-lake-green modal-container">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                    {{ editingItem.originalIndex !== null ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}
                </h3>
                
                <form @submit.prevent="saveItem" class="space-y-4">
                    <div>
                        <label for="time" class="block text-sm font-medium text-gray-700">æ™‚é–“ (å¦‚: 14:00 / å¤šçµ„æ™‚åˆ»è¡¨)</label>
                        <input id="time" v-model="editingItem.time" type="text" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-accent focus:border-accent text-gray-800"
                               placeholder="æ™‚é–“æ®µæˆ–å¤šçµ„æ™‚åˆ»è¡¨ï¼Œä¾‹å¦‚: 10:30 / 11:30"
                        >
                    </div>
                    <div>
                        <label for="item" class="block text-sm font-medium text-gray-700">åœ°é» / æ´»å‹•åç¨±</label>
                        <input id="item" v-model="editingItem.item" type="text" required
                               class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-accent focus:border-accent text-gray-800"
                               placeholder="æ‹™æ”¿åœ’ / é«˜éµ"
                        >
                    </div>
                    <div>
                        <label for="detail" class="block text-sm font-medium text-gray-700">ç´°ç¯€æè¿°</label>
                        <textarea id="detail" v-model="editingItem.detail" rows="3"
                                  class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-accent focus:border-accent text-gray-800"
                                  placeholder="éœ€æå‰ 7 å¤©é ç´„ / äºŒç­‰åº§ 3é¸1"
                        ></textarea>
                    </div>
                    <div>
                        <label for="cost" class="block text-sm font-medium text-gray-700">é ä¼°è²»ç”¨ (äººæ°‘å¹£ï¼Œæ•¸å­—æˆ–æ–‡å­—)</label>
                        <input id="cost" v-model="editingItem.cost" type="text"
                               class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-accent focus:border-accent text-gray-800"
                               placeholder="70 æˆ– 600-800 /è»Š"
                        >
                    </div>
                    
                    <div class="flex justify-between pt-4">
                        <button type="button" @click="isModalOpen = false"
                                class="w-1/2 py-3 mr-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors font-semibold"
                        >
                            å–æ¶ˆ
                        </button>
                        <button type="submit"
                                class="w-1/2 py-3 ml-2 rounded-lg text-white bg-lake-green hover:bg-accent transition-colors font-semibold"
                        >
                            å„²å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </transition>

    <!-- 6. LLM å»ºè­° Modal è¦–çª— -->
    <transition name="modal">
        <div v-if="isSuggestionModalOpen" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay backdrop-blur-sm">
            <div class="bg-white w-11/12 sm:w-5/6 lg:w-1/2 max-h-[80vh] overflow-y-auto p-6 rounded-2xl shadow-2xl transform transition-all duration-300 scale-100 border-t-8 border-yellow-500 modal-container">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <span class="text-yellow-600 text-2xl mr-2">ğŸ’¡</span>
                    {{ generatingItemName }} çš„æ›¿ä»£æ–¹æ¡ˆå»ºè­°
                </h3>

                <div v-if="suggestionResult.text" class="prose max-w-none">
                    <!-- é¡¯ç¤º Markdown æ ¼å¼çš„å»ºè­°æ–‡æœ¬ -->
                    <div v-html="renderMarkdown(suggestionResult.text)" class="text-gray-700 mb-6"></div>

                    <!-- å¼•ç”¨ä¾†æº -->
                    <div v-if="suggestionResult.sources.length" class="mt-4 pt-4 border-t border-gray-100 text-xs text-gray-500">
                        <p class="font-semibold mb-1">åƒè€ƒè³‡è¨Šä¾†æº (Google æœå°‹):</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li v-for="(source, sIndex) in suggestionResult.sources" :key="sIndex">
                                <a :href="source.uri" target="_blank" class="text-accent hover:underline">{{ source.title || source.uri }}</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div v-else class="text-gray-500 text-center py-6">
                    <span v-if="isGenerating" class="animate-spin inline-block mr-2 text-lake-green">ğŸ”„</span>
                    è¼‰å…¥ä¸­... æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆæ˜¥ç¯€æœŸé–“çš„å‚™é¸å»ºè­°ã€‚
                </div>

                <div class="flex justify-center pt-6">
                    <button type="button" @click="isSuggestionModalOpen = false"
                            class="py-3 px-8 rounded-lg text-white bg-yellow-600 hover:bg-yellow-700 transition-colors font-semibold shadow-md"
                    >
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </transition>
    
    <!-- 7. äº¤é€šæŒ‡å—èˆ‡æ³¨æ„äº‹é … Modal è¦–çª— -->
    <transition name="modal">
        <div v-if="isGuideModalOpen" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay backdrop-blur-sm">
            <div class="bg-white w-11/12 sm:w-5/6 lg:w-1/2 max-h-[90vh] overflow-y-auto p-6 rounded-2xl shadow-2xl transform transition-all duration-300 scale-100 border-t-8 border-accent modal-container">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <span class="text-lake-green text-2xl mr-2">ğŸ—ºï¸</span>
                    æ˜¥ç¯€äº¤é€šæ­è»ŠæŒ‡å—èˆ‡æ³¨æ„äº‹é …ç¸½çµ
                </h3>

                <!-- å…§å®¹å€å¡Š -->
                <div class="space-y-6">
                    <!-- A. äº¤é€šç¸½çµ -->
                    <div class="border p-4 rounded-xl bg-gray-50">
                        <h4 class="text-lg font-bold text-lake-green mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            é—œéµäº¤é€šè·¯ç·šèˆ‡æ­ä¹˜æŒ‡å¼•
                        </h4>
                        <ul class="list-disc list-inside space-y-2 text-gray-700">
                            <li v-for="(transport, tIndex) in guideSummary.transport" :key="tIndex" class="text-sm">
                                <strong>Day {{ transport.day }} - {{ transport.item }} ({{ transport.time }})ï¼š</strong> {{ transport.detail }} <span class="font-semibold text-red-500">({{ formatCost(transport.cost) }})</span>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- B. æ˜¥ç¯€é«˜å³°èˆ‡æ“æ“ è­¦å‘Š -->
                    <div class="border p-4 rounded-xl bg-red-50 border-red-300">
                        <h4 class="text-lg font-bold text-red-700 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            æ¯æ—¥æ˜¥ç¯€äººæµèˆ‡æ³¨æ„äº‹é …
                        </h4>
                        <ul class="list-disc list-inside space-y-2 text-red-800">
                            <li v-for="(warning, wIndex) in guideSummary.warnings" :key="wIndex" class="text-sm">
                                <strong>{{ warning.day }} ({{ warning.city }})ï¼š</strong> <span v-html="warning.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')"></span>
                            </li>
                        </ul>
                    </div>

                    <!-- C. ä¸€èˆ¬å»ºè­° -->
                    <div class="text-sm text-gray-600 border-t pt-4">
                        <p class="font-bold text-gray-800 mb-2">ğŸ’¡ ç¸½é«”æ—…è¡Œå»ºè­°:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>äº¤é€šï¼š</strong> æ˜¥ç¯€æœŸé–“é«˜éµã€å¤§å·´ç¥¨å‹™ç·Šå¼µï¼Œå»ºè­°æå‰è‡³å°‘ 30 å¤©é è¨‚ã€‚</li>
                            <li><strong>æ™¯é»ï¼š</strong> å‹™å¿…ä½¿ç”¨å®˜æ–¹ App æˆ–å°ç¨‹åºæå‰æŸ¥çœ‹æ™¯é»é–‹é–‰æ™‚é–“å’Œé ç´„è¦æ±‚ï¼ˆå°¤å…¶æ˜¯è˜‡å·åšç‰©é¤¨ï¼‰ã€‚</li>
                            <li><strong>é¤é£²ï¼š</strong> é™¤å¤•è‡³åˆä¸‰ï¼Œè¨±å¤šç¨ç«‹å°åº—æœƒæ­‡æ¥­ï¼Œå»ºè­°å‚™æ¡ˆé€£é–é¤å»³æˆ–åœ¨é£¯åº—å…§ç”¨é¤ã€‚</li>
                        </ul>
                    </div>
                </div>

                <div class="flex justify-center pt-6">
                    <button type="button" @click="isGuideModalOpen = false"
                            class="py-3 px-8 rounded-lg text-white bg-lake-green hover:bg-accent transition-colors font-semibold"
                    >
                        ç­è§£
                    </button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed } = Vue;

    // ===========================================
    // âš ï¸ [æ­¥é©Ÿä¸€] è¨­ç½® Firebase é›²ç«¯è³‡æ–™åº«é…ç½® (å·²æ›´æ–°æ‚¨çš„åƒæ•¸)
    // ===========================================
    const firebaseConfig = {
        apiKey: "AIzaSyAStFZD476TFwl7Q_6eYX8c4tPKLvR6cAk",
        authDomain: "linfamily-120ad.firebaseapp.com",
        projectId: "linfamily-120ad", 
        storageBucket: "linfamily-120ad.firebasestorage.app",
        messagingSenderId: "92686138706",
        appId: "1:92686138706:web:2846e8480a2c14f4c44e8b",
        measurementId: "G-N7PBTP6ZCS"
    };

    // åˆå§‹åŒ– Firebase
    let db;
    let itineraryRef;
    try {
        const app = firebase.initializeApp(firebaseConfig);
        db = app.firestore();
        // æˆ‘å€‘å°‡æ‰€æœ‰è¡Œç¨‹æ•¸æ“šå„²å­˜åœ¨ Firestore ä¸­åç‚º 'itineraries' é›†åˆä¸‹çš„ 'sugangTrip' æ–‡ä»¶ä¸­
        itineraryRef = db.collection("itineraries").doc("sugangTrip");
        console.log("Firebase æœå‹™å·²åˆå§‹åŒ–ï¼Œé€£æ¥åˆ°å°ˆæ¡ˆ:", firebaseConfig.projectId);
    } catch (e) {
        console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼šè«‹æª¢æŸ¥ firebaseConfigã€‚", e);
        // å¦‚æœåˆå§‹åŒ–å¤±æ•—ï¼Œå‰‡ä¸è¨­å®š itineraryRef
        itineraryRef = null;
    }
    // ===========================================


    // ===========================================
    // âš ï¸ [æ­¥é©ŸäºŒ] è¨­ç½® Gemini LLM API Key (é¸å¡« - ç•™ç©ºå‰‡åŠŸèƒ½ç¦ç”¨)
    // ===========================================
    const geminiApiKey = "AIzaSyCujbgqNjgcPVyG7SuQaId0X4KAJ527QFc"; // æ›¿æ›ç‚ºæ‚¨çš„ Gemini API Key
    const LLM_MODEL = "gemini-2.5-flash-preview-09-2025";
    // ===========================================
    
    // åˆå§‹æ•¸æ“š (åƒ…ç”¨æ–¼é¦–æ¬¡éƒ¨ç½²æ™‚ï¼Œè³‡æ–™åº«ä¸­æ²’æœ‰æ•¸æ“šçš„æƒ…æ³)
    const fullItineraryData = [
        {
            day: 1,
            date: '2/15 (æ—¥)',
            city: 'ä¸Šæµ· â” è˜‡å·',
            title: 'å°åŒ— â” ä¸Šæµ· â” è˜‡å· (æŠµé”æ—¥)',
            weather: 'å¤šé›²è½‰é™°',
            temp: '3Â°C ~ 8Â°C',
            cnyWarning: 'å±±å¡˜è¡—æ˜¥ç¯€ç‡ˆé£¾æœƒæ›´è±å¯Œï¼Œä½†äººæµæœƒåœ¨æ™šé£¯å¾Œæ¹§å…¥ã€‚é™¤å¤•å¤œå°åƒåº—å¤šæ•¸ä¼‘æ¯ï¼Œå»ºè­°é£¯åº—å…§ç”¨é¤ã€‚',
            schedule: [
                { time: '14:40 â” 16:30', item: 'åœ‹éš›èˆªç­ï¼šå°åŒ— â” ä¸Šæµ· (è™¹æ©‹ T1)', detail: 'ç”¨æ™‚ 1å°æ™‚ 50åˆ†', cost: 0, type: 'plane' },
                { time: '18:22 / 18:52 / 19:00', item: 'é«˜éµï¼šä¸Šæµ·è™¹æ©‹ â” è˜‡å·', detail: 'è»Šç¨‹ç´„ 32-35 åˆ†é˜ (3é¸1è»Šæ¬¡)', cost: 39.5, type: 'train', location: { name: 'è˜‡å·ç«™', lat: 31.3149, lng: 120.6190 } },
                { 
                    time: 'æ™šé–“', 
                    item: 'æ™¯é»ï¼šå±±å¡˜è¡—å¤œæ™¯', 
                    detail: 'åœ°éµ/æ»´æ»´å‰å¾€è˜‡å·å±±å¡˜è¡—', 
                    cost: '10-25 /è»Š', 
                    type: 'local',
                    location: { name: 'å±±å¡˜è¡—', lat: 31.3197, lng: 120.5960 }
                },
            ],
        },
        {
            day: 2,
            date: '2/16 (ä¸€)',
            city: 'è˜‡å·å¸‚å€',
            title: 'è˜‡å·å¸‚å€éŠ (é™¤å¤•)',
            weather: 'é™°å¤©',
            temp: '3Â°C ~ 7Â°C',
            cnyWarning: 'ğŸš¨ **æå‰é ç´„ï¼š** è˜‡å·åšç‰©é¤¨å¿…é ˆæå‰ 7 å¤©é ç´„ã€‚æ™¯é»åœ¨é™¤å¤•ç•¶å¤© (2/16) æœƒææ—©è‡³ **15:00-16:00** åœæ­¢å”®ç¥¨åŠé—œé–€ï¼Œè«‹å‹™å¿…æ—©ä¸ŠæŠµé”ã€‚é¤é£²ï¼šé™¤å¤•åˆé¤åƒ…èƒ½é¸æ“‡å°‘æ•¸ç°¡é¤åº—æˆ–é€£é–é¤å»³ã€‚',
            schedule: [
                { 
                    time: '08:30 â” 12:00', 
                    item: 'æ™¯é»ï¼šæ‹™æ”¿åœ’ / è˜‡å·åšç‰©é¤¨', 
                    detail: 'éœ€é ç´„ï¼Œå»ºè­°ä¸€æ—©å‰å¾€é¿é–‹äººæ½®', 
                    cost: 'æ‹™æ”¿åœ’ Â¥70', 
                    type: 'attraction',
                    location: { name: 'æ‹™æ”¿åœ’/è˜‡åš', lat: 31.3259, lng: 120.6270 }
                },
                { 
                    time: '13:00 â” 15:30', 
                    item: 'æ™¯é»ï¼šå¹³æ±Ÿè·¯æ­·å²è¡—å€', 
                    detail: 'åœ¨è€åŸå€æ¼«æ­¥ï¼Œé¿é–‹ä¸‹åˆé—œé–€æ½®', 
                    cost: 0, 
                    type: 'attraction',
                    location: { name: 'å¹³æ±Ÿè·¯', lat: 31.3204, lng: 120.6358 }
                },
                { time: 'æ™šé–“', item: 'æ™šé¤ï¼šé£¯åº—å…§å¹´å¤œé£¯ (å¼·çƒˆæ¨è–¦)', detail: 'éœ€æå‰æ•¸æœˆé è¨‚', cost: '400-800 /äºº', type: 'food' },
            ],
        },
        {
            day: 3,
            date: '2/17 (äºŒ)',
            city: 'è˜‡å·å¸‚å€',
            title: 'è˜‡å·å¸‚å€éŠ (åˆä¸€)',
            weather: 'å¤šé›²',
            temp: '4Â°C ~ 9Â°C',
            cnyWarning: 'âš ï¸ **å¯ºå»Ÿè­¦å‘Šï¼š** åˆä¸€ (2/17) æ˜¯å¯’å±±å¯ºé¦™ç«æœ€ç››ä¹‹æ—¥ï¼Œäººæµå°‡æ¡å–åš´æ ¼ç®¡åˆ¶ï¼Œæœƒè€—è²»å¤§é‡æ’éšŠæ™‚é–“ã€‚æ¨è–¦å°ˆæ³¨åƒè§€ **è™ä¸˜**ï¼Œè™ä¸˜ç›¸å°è¼ƒåˆ†æ•£ï¼Œäººæµå£“åŠ›è¼ƒå°ã€‚',
            schedule: [
                { 
                    time: '08:30 â” 12:30', 
                    item: 'æ™¯é»ï¼šè™ä¸˜ / å¯’å±±å¯º (æ“‡ä¸€)', 
                    detail: 'è™ä¸˜äººæµè¼ƒå°‘ï¼Œæ¨è–¦å„ªå…ˆ', 
                    cost: 'è™ä¸˜ Â¥60', 
                    type: 'attraction',
                    location: { name: 'è™ä¸˜', lat: 31.3323, lng: 120.5732 }
                },
                { 
                    time: '14:00 â” 17:00', 
                    item: 'æ™¯é»ï¼šé‡‘é›æ¹–æ™¯å€', 
                    detail: 'å‘¨é‚Šå•†å ´è¨­æ–½æ­£å¸¸ç‡Ÿæ¥­ï¼Œæ˜¯é¿é–‹è€åŸå€äººæ½®çš„å¥½é¸æ“‡', 
                    cost: 0, 
                    type: 'attraction',
                    location: { name: 'é‡‘é›æ¹–', lat: 31.3142, lng: 120.6720 }
                },
                { time: 'ç•¶åœ°äº¤é€š', item: 'åœ°éµ/æ»´æ»´è²»ç”¨', detail: 'è€åŸå€ â” é‡‘é›æ¹–ç´„ Â¥5 /äºº', cost: '5-40 /äºº', type: 'local' },
            ],
        },
        {
            day: 4,
            date: '2/18 (ä¸‰)',
            city: 'è˜‡å· â” çƒé®',
            title: 'å‰å¾€æ°´é„‰çƒé® (è¥¿æŸµ)',
            weather: 'å°é›¨',
            temp: '2Â°C ~ 6Â°C',
            cnyWarning: 'ğŸš¨ **çƒé®è¥¿æŸµï¼š** æ–æ«“èˆ¹å’Œå¤œæ™¯æ¸¡èˆ¹æœƒå¤§æ’é•·é¾ã€‚æ™¯å€å…§é¤å»³å¹¾ä¹å…¨éƒ¨çˆ†æ»¿ï¼Œå‹™å¿…åœ¨ **17:00** å‰å°±å»æ’éšŠã€‚',
            schedule: [
                { time: '10:00 ç™¼', item: 'äº¤é€šï¼šç§äººåŒ…è»Š (é–€å°é–€)', detail: 'è˜‡å·æ—¥èˆª â” çƒé®è¥¿æŸµæ™¯å€ (ç´„ 1.5 å°æ™‚)', cost: '600-800 /è»Š', type: 'car' },
                { 
                    time: 'ä¸‹åˆ', 
                    item: 'æ™¯é»ï¼šçƒé®è¥¿æŸµç™½æ—¥éŠ', 
                    detail: 'æ™¯å€å…§å…¥ä½é€šå®‰å®¢æ£§ï¼Œæ–¹ä¾¿å¤œéŠ', 
                    cost: 'é–€ç¥¨ Â¥150', 
                    type: 'attraction',
                    location: { name: 'çƒé®è¥¿æŸµ', lat: 30.7486, lng: 120.4795 }
                },
                { time: 'æ™šé–“', item: 'æ™¯é»ï¼šè¥¿æŸµå¤œæ™¯ (é‡é»)', detail: 'å¤œéŠäººæ½®å·¨å¤§ï¼Œéœ€æå‰è¦åŠƒè·¯ç·š', cost: 0, type: 'attraction' },
            ],
        },
        {
            day: 5,
            date: '2/19 (å››)',
            city: 'çƒé® â” æ­å·',
            title: 'å‰å¾€æ­å·ï¼Œè¥¿æ¹–åˆé«”é©—',
            weather: 'å¤šé›²',
            temp: '4Â°C ~ 10Â°C',
            cnyWarning: 'âš ï¸ **è¥¿æ¹–ï¼š** åˆå›› (2/19) é–‹å§‹è¿”é„‰/éŠå®¢é«˜å³°ï¼Œè¥¿æ¹–å‘¨é‚Šé“è·¯æœƒæœ‰åš´æ ¼çš„äº¤é€šç®¡åˆ¶ï¼Œè¨ˆç¨‹è»Šå¯èƒ½ç„¡æ³•ç›´é”æ ¸å¿ƒæ™¯é»ã€‚éŠèˆ¹ç¢¼é ­æ’éšŠäººæ•¸æœƒæ¯”å¹³æ™‚å¤š 2-3 å€ã€‚',
            schedule: [
                { time: '10:30 / 11:30 / 12:30', item: 'äº¤é€šï¼šç›´é”å¤§å·´ (3é¸1)', detail: 'çƒé®å®¢é‹ç«™ â” æ­å·æ±ç«™ (ç´„ 1.5 å°æ™‚)', cost: '35-50 /äºº', type: 'bus' },
                { 
                    time: 'ä¸‹åˆ', 
                    item: 'æ™¯é»ï¼šè¥¿æ¹–ç’°æ¹–æ¼«æ­¥', 
                    detail: 'å»ºè­°å¾æ¹–æ¿±è·¯é–‹å§‹ï¼Œæ­ä¹˜ç’°æ¹–é›»ç“¶è»Š', 
                    cost: 'é›»ç“¶è»Š Â¥40-50 /äºº', 
                    type: 'attraction',
                    location: { name: 'è¥¿æ¹– (æ¹–æ¿±è·¯)', lat: 30.2599, lng: 120.1585 }
                },
                { time: 'æ™šé¤', item: 'å¤–å©†å®¶/ç¶ èŒ¶é¤å»³', detail: 'æ­å·çŸ¥åé€£é–ï¼Œéœ€æº–å‚™æ’éšŠ', cost: '100-200 /äºº', type: 'food' },
            ],
        },
        {
            day: 6,
            date: '2/20 (äº”)',
            city: 'æ­å· â‡„ åƒå³¶æ¹–',
            title: 'åƒå³¶æ¹–ä¸€æ—¥éŠ',
            weather: 'æ™´æ™‚å¤šé›²',
            temp: '5Â°C ~ 12Â°C',
            cnyWarning: 'ğŸ’¡ **åƒå³¶æ¹–ï¼š** ç¢¼é ­ç™»èˆ¹æ‰‹çºŒå’Œå„å³¶é–“çš„æ¸¡èˆ¹ä»å¯èƒ½æ’éšŠï¼Œå»ºè­°æ—©ä¸Šæ­ä¹˜æœ€æ—©ç­æ¬¡é«˜éµã€‚å‚™æ¡ˆï¼šè‹¥é¸æ“‡å¸‚å€éˆéš±å¯ºï¼Œäººæµå·¨å¤§ï¼Œè«‹æ­ä¹˜å…¬å…±äº¤é€šã€‚',
            schedule: [
                // å·²æœ‰ 3 é¸ 1ï¼Œæ–°å¢ detail èªªæ˜
                { time: '08:33 / 09:12 / 10:07', item: 'å»ç¨‹é«˜éµï¼šæ­å·æ± â” åƒå³¶æ¹–ç«™', detail: 'è»Šç¨‹ç´„ 1 å°æ™‚ (3é¸1è»Šæ¬¡)', cost: 70, type: 'train', location: { name: 'åƒå³¶æ¹–ç«™', lat: 29.5630, lng: 119.0069 } },
                { 
                    time: 'ç•¶æ—¥', 
                    item: 'æ™¯é»ï¼šåƒå³¶æ¹–ç™»å³¶éŠè¦½', 
                    detail: 'éœ€å¾é«˜éµç«™è½‰æ¥é§å·´å£«/æ»´æ»´å‰å¾€ç¢¼é ­', 
                    cost: 'èˆ¹ç¥¨/é–€ç¥¨ Â¥200+', 
                    type: 'attraction',
                    location: { name: 'åƒå³¶æ¹– (ä¸­å¿ƒæ¹–å€)', lat: 29.5393, lng: 119.0069 }
                },
                // å·²æœ‰ 3 é¸ 1ï¼Œæ–°å¢ detail èªªæ˜
                { time: '17:28 / 18:14 / 18:50', item: 'å›ç¨‹é«˜éµï¼šåƒå³¶æ¹–ç«™ â” æ­å·æ±', detail: 'è»Šç¨‹ç´„ 1 å°æ™‚ (3é¸1è»Šæ¬¡)', cost: 70, type: 'train', location: { name: 'æ­å·æ±ç«™', lat: 30.3168, lng: 120.2104 } },
            ],
        },
        {
            day: 7,
            date: '2/21 (å…­)',
            city: 'æ­å· â” ä¸Šæµ· â” å°åŒ—',
            title: 'è¿”ç¨‹æ—¥ (åˆå…­é«˜å³°)',
            weather: 'å¤šé›²',
            temp: '6Â°C ~ 10Â°C',
            cnyWarning: 'âš ï¸ **è¿”ç¨‹é«˜å³°ï¼š** åˆå…­æ˜¯æ˜¥ç¯€è¿”ç¨‹é«˜å³°çš„å°¾è²ï¼Œé«˜éµç¥¨ç·Šå¼µï¼Œä¸”ä¸Šæµ·è™¹æ©‹æ©Ÿå ´äººæ½®å·¨å¤§ã€‚è«‹å‹™å¿…é ç•™å……è¶³çš„è½‰è»Šå’Œå®‰æª¢æ™‚é–“ (è‡³å°‘ 3 å°æ™‚)ã€‚',
            schedule: [
                { time: 'ä¸Šåˆ', item: 'æ™¯é»ï¼šé£¯åº—é™„è¿‘è‡ªç”±æ´»å‹•/è³¼è²·ä¼´æ‰‹ç¦®', detail: 'å»ºè­°åœ¨æ­å·å¸‚å€è¼•é¬†åº¦é', cost: 0, type: 'local' },
                // å·²æœ‰ 3 é¸ 1ï¼Œæ–°å¢ detail èªªæ˜
                { time: '15:21 / 15:43 / 16:15', item: 'é«˜éµï¼šæ­å·æ± â” ä¸Šæµ·è™¹æ©‹', detail: 'è»Šç¨‹ç´„ 47 åˆ†é˜ (3é¸1è»Šæ¬¡)', cost: 73, type: 'train', location: { name: 'ä¸Šæµ·è™¹æ©‹ç«™', lat: 31.1818, lng: 121.3283 } },
                { time: '19:40 â” 21:45', item: 'åœ‹éš›èˆªç­ï¼šä¸Šæµ·è™¹æ©‹ â” å°åŒ—', detail: 'é«˜éµä¸‹è»Šå¾Œéœ€è½‰ T2 èˆªå»ˆ', cost: 0, type: 'plane' },
            ],
        },
    ];

    createApp({
        setup() {
            // Vue ç‹€æ…‹ç®¡ç†
            const currentDate = ref(1); // ç•¶å‰é¸æ“‡çš„æ—¥æœŸ (Day 1-7)
            const itinerary = ref([]);  // è¡Œç¨‹æ•¸æ“šï¼Œå¾ Firebase è¼‰å…¥
            const isLoading = ref(true); // è¼‰å…¥ç‹€æ…‹

            const isModalOpen = ref(false); // æ–°å¢/ç·¨è¼¯ Modal
            const editingItem = ref({ // ç”¨æ–¼ç·¨è¼¯æˆ–æ–°å¢çš„è³‡æ–™æš«å­˜
                time: '',
                item: '',
                detail: '',
                cost: '',
                type: 'local',
                originalDay: null, // è¨˜éŒ„åŸå§‹ Day
                originalIndex: null // è¨˜éŒ„åŸå§‹ Index
            });

            // === LLM ç›¸é—œç‹€æ…‹ ===
            const suggestionResult = ref({ text: '', sources: [] });
            const isGenerating = ref(false);
            const isSuggestionModalOpen = ref(false);
            const generatingItemName = ref('');
            // ===========================

            // === äº¤é€šæŒ‡å—ç‹€æ…‹ ===
            const isGuideModalOpen = ref(false);
            // ===========================

            // ----------------------------------------------------
            // ğŸ”¥ Firebase æ•¸æ“šåŒæ­¥è™•ç† (æ›¿ä»£ Local Storage)
            // ----------------------------------------------------

            // å¯«å…¥æ•¸æ“šåˆ° Firestore
            const updateFirestore = async (newItinerary) => {
                if (!itineraryRef) {
                    console.error("Firestore å¼•ç”¨æœªè¨­å®šï¼Œç„¡æ³•å„²å­˜ã€‚");
                    return;
                }
                try {
                    // ğŸŒŸ ä¿®æ­£çš„é—œéµè¡Œ: ä½¿ç”¨ JSON åºåˆ—åŒ–ä¾†ç§»é™¤ Vue çš„åæ‡‰æ€§ä»£ç†ï¼Œç¢ºä¿ Firestore å„²å­˜ç´”æ·¨çš„è³‡æ–™
                    const cleanData = JSON.parse(JSON.stringify(newItinerary));
                    
                    // å°‡æ•´å€‹è¡Œç¨‹é™£åˆ—å„²å­˜ç‚ºä¸€å€‹ document
                    await itineraryRef.set({ data: cleanData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    console.log("æ•¸æ“šå·²æˆåŠŸåŒæ­¥è‡³ Firebaseã€‚");
                } catch (e) {
                    console.error("Error writing document to Firestore: ", e);
                    // é€™è£¡ä½¿ç”¨ window.confirm è€Œé alertï¼Œä½†ç”±æ–¼ Immersive ç’°å¢ƒè¦æ±‚ï¼Œé€™è£¡ä¿ç•™ alert æˆ–ä½¿ç”¨è‡ªå®šç¾© Modal
                    window.confirm("å„²å­˜å¤±æ•—ï¼šç„¡æ³•åŒæ­¥è³‡æ–™åˆ°é›²ç«¯ã€‚è«‹æª¢æŸ¥ Firebase è¦å‰‡æˆ–è³‡æ–™çµæ§‹ã€‚");
                }
            };
            
            // ç›£è½å™¨ï¼šå¾ Firestore å³æ™‚è®€å–æ•¸æ“š
            if (itineraryRef) {
                itineraryRef.onSnapshot(doc => {
                    if (doc.exists && doc.data().data) {
                        // æ•¸æ“šå­˜åœ¨ï¼Œç›´æ¥æ›´æ–°æœ¬åœ° Vue ç‹€æ…‹
                        itinerary.value = doc.data().data;
                        console.log("è¡Œç¨‹æ•¸æ“šå·²å¾ Firebase åŒæ­¥ã€‚");
                    } else {
                        // æ•¸æ“šåº«ä¸­æ²’æœ‰æ•¸æ“š (é¦–æ¬¡é‹è¡Œ)ï¼Œä½¿ç”¨éœæ…‹æ•¸æ“šåˆå§‹åŒ–ä¸¦å¯«å…¥é›²ç«¯
                        itinerary.value = fullItineraryData;
                        updateFirestore(fullItineraryData);
                        console.log("Firebase æ•¸æ“šåº«ç‚ºç©ºï¼Œä½¿ç”¨éœæ…‹æ•¸æ“šåˆå§‹åŒ–ã€‚");
                    }
                    isLoading.value = false;
                }, error => {
                    console.error("Firestore å³æ™‚ç›£è½å¤±æ•—:", error);
                    isLoading.value = false;
                    window.confirm("ç„¡æ³•é€£æ¥åˆ° Firebase è³‡æ–™åº«ã€‚è³‡æ–™å°‡ä¸æœƒåŒæ­¥ã€‚");
                    // é€£ç·šå¤±æ•—æ™‚ï¼Œä»ä½¿ç”¨éœæ…‹æ•¸æ“šæˆ–å·²è¼‰å…¥çš„ç©ºæ•¸æ“š
                    if (itinerary.value.length === 0) {
                        itinerary.value = fullItineraryData;
                    }
                });
            } else {
                // å¦‚æœ Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œå‰‡ç›´æ¥ä½¿ç”¨éœæ…‹æ•¸æ“šä¸¦é—œé–‰ Loading
                itinerary.value = fullItineraryData;
                isLoading.value = false;
            }

            // ----------------------------------------------------
            // ----------------------------------------------------

            // --- Computed Properties ---
            
            // æ–°å¢: äº¤é€šæŒ‡å—ç¸½çµ
            const guideSummary = computed(() => {
                const transport = [];
                const warnings = [];

                itinerary.value.forEach(day => {
                    // 1. æ”¶é›†äº¤é€šè³‡è¨Š
                    day.schedule.forEach(item => {
                        // åªæ”¶é›†æœ‰è²»ç”¨çš„äº¤é€šé …ç›®ï¼Œæˆ–è²»ç”¨ç‚º 0 ä½†é¡å‹æ˜¯ plane/train/bus/car çš„é …ç›®
                        if (['plane', 'train', 'bus', 'car', 'local'].includes(item.type) && (item.cost !== 0 || item.type !== 'local')) {
                            transport.push({
                                day: day.day,
                                city: day.city,
                                item: item.item,
                                detail: item.detail,
                                time: item.time,
                                cost: item.cost,
                                type: item.type
                            });
                        }
                    });

                    // 2. æ”¶é›†æ˜¥ç¯€è­¦å‘Š
                    if (day.cnyWarning) {
                        warnings.push({
                            day: day.date,
                            city: day.city,
                            text: day.cnyWarning
                        });
                    }
                });

                return { transport, warnings };
            });


            const currentDay = computed(() => {
                // å¾ itinerary é™£åˆ—ä¸­æ‰¾åˆ°ç•¶å‰é¸æ“‡çš„æ—¥æœŸæ•¸æ“š
                return itinerary.value.find(day => day.day === currentDate.value) || { schedule: [] };
            });

            // --- Utility Functions ---

            const formatCost = (cost) => {
                // æ ¼å¼åŒ–è²»ç”¨é¡¯ç¤º
                if (cost === 0 || cost === '0') return 'å…è²»';
                if (typeof cost === 'number') return `Â¥ ${cost}`;
                // è™•ç†è²»ç”¨ç¯„åœæˆ–æ–‡å­—æè¿°
                return `Â¥ ${cost}`;
            };
            
            const getWeatherIcon = (weather) => {
                if (weather?.includes('æ™´')) return '<span>â˜€ï¸</span>';
                if (weather?.includes('é›¨')) return '<span>ğŸŒ§ï¸</span>';
                if (weather?.includes('é™°')) return '<span>â˜ï¸</span>';
                if (weather?.includes('å¤šé›²')) return '<span>ğŸŒ¥ï¸</span>';
                return '<span>ğŸŒ¡ï¸</span>';
            };

            const getScheduleIcon = (type) => {
                switch (type) {
                    case 'plane': return '<span>âœˆï¸</span>';
                    case 'train': return '<span>ğŸš„</span>';
                    case 'bus': return '<span>ğŸšŒ</span>';
                    case 'car': return '<span>ğŸš—</span>';
                    case 'attraction': return '<span>ğŸ›ï¸</span>'; // æ™¯é»
                    case 'food': return '<span>ğŸ²</span>';
                    default: return '<span>ğŸ“</span>'; // å…¶ä»–/ç•¶åœ°äº¤é€š
                }
            };
            
            // ç°¡å–®çš„ Markdown æ¸²æŸ“ (å°‡ * List å’Œ **Bold** è½‰æ›ç‚º HTML)
            const renderMarkdown = (text) => {
                if (!text) return '';
                let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                let listHtml = [];
                let isList = false;
                const lines = html.split('\n');
                
                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('* ')) {
                        if (!isList) { listHtml.push('<ul>'); isList = true; }
                        listHtml.push(`<li>${trimmedLine.substring(2).trim()}</li>`);
                    } else {
                        if (isList) { listHtml.push('</ul>'); isList = false; }
                        if (trimmedLine) { listHtml.push(`<p>${trimmedLine}</p>`); }
                    }
                });
                if (isList) { listHtml.push('</ul>'); }
                return listHtml.join('');
            };


            // --- Methods ---

            const setCurrentDate = (day) => {
                currentDate.value = day;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const openAddItemModal = () => {
                // é‡ç½®ç·¨è¼¯é …ç›®ç‚ºç©ºç™½ï¼Œæº–å‚™æ–°å¢
                editingItem.value = {
                    time: '',
                    item: '',
                    detail: '',
                    cost: '',
                    type: 'local',
                    originalDay: currentDate.value,
                    originalIndex: null
                };
                isModalOpen.value = true;
            };

            const editItem = (day, index) => {
                const dayData = itinerary.value.find(d => d.day === day);
                if (dayData && dayData.schedule[index]) {
                    const itemToEdit = { ...dayData.schedule[index] };
                    editingItem.value = { 
                        ...itemToEdit,
                        originalDay: day,
                        originalIndex: index
                    };
                    // ç¢ºä¿ location ä¸è¢«å‚³éåˆ°ç·¨è¼¯è¡¨å–®ï¼Œå› ç‚ºå®ƒæ˜¯ä¸€å€‹éç·¨è¼¯å­—æ®µ
                    delete editingItem.value.location; 
                    isModalOpen.value = true;
                }
            };

            const saveItem = () => {
                const dayData = itinerary.value.find(d => d.day === editingItem.value.originalDay);
                if (!dayData) {
                    isModalOpen.value = false;
                    return;
                }

                const newItem = {
                    time: editingItem.value.time,
                    item: editingItem.value.item,
                    detail: editingItem.value.detail,
                    cost: editingItem.value.cost,
                    type: editingItem.value.type || 'local',
                };

                if (editingItem.value.originalIndex !== null) {
                    const existingItem = dayData.schedule[editingItem.value.originalIndex];
                    // åˆä½µèˆŠé …ç›®ä¸­çš„ locationï¼ˆå¦‚æœå­˜åœ¨ï¼‰å’Œæ–°é …ç›®çš„å€¼
                    dayData.schedule[editingItem.value.originalIndex] = { 
                        ...(existingItem.location && { location: existingItem.location }), 
                        ...newItem 
                    };
                } else {
                    dayData.schedule.push(newItem);
                    // æ ¹æ“šæ™‚é–“é€²è¡Œç°¡å–®æ’åº
                    dayData.schedule.sort((a, b) => (a.time > b.time) ? 1 : -1);
                }
                
                isModalOpen.value = false;
                // ğŸŒŸ [åŒæ­¥] å„²å­˜è®Šæ›´åˆ° Firestore
                updateFirestore(itinerary.value);
            };

            const deleteItem = (day, index) => {
                // ä½¿ç”¨è‡ªå®šç¾© modal æ›¿ä»£ alert
                const deleteConfirmed = window.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ');
                if (deleteConfirmed) {
                    const dayData = itinerary.value.find(d => d.day === day);
                    if (dayData && dayData.schedule.length > index) {
                        dayData.schedule.splice(index, 1);
                        // ğŸŒŸ [åŒæ­¥] å„²å­˜è®Šæ›´åˆ° Firestore
                        updateFirestore(itinerary.value);
                    }
                }
            };

            const openMap = (locationName) => {
                // æ‰“é–‹ Google åœ°åœ–é€²è¡Œå°èˆª
                window.open(`https://www.google.com/maps/search/${locationName}`, '_blank');
            };
            
            // === LLM æ ¸å¿ƒåŠŸèƒ½: ç”Ÿæˆæ›¿ä»£æ–¹æ¡ˆ ===
            const exponentialBackoffFetch = async (url, options, maxRetries = 5) => {
                for (let retries = 0; retries < maxRetries; retries++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.status === 429 && retries < maxRetries - 1) {
                            const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        if (!response.ok) {
                            // æ‹‹å‡ºåŒ…å«ç‹€æ…‹çš„éŒ¯èª¤
                            throw new Error(`API éŒ¯èª¤: ${response.status} ${response.statusText}`);
                        }
                        return response;
                    } catch (error) {
                        if (retries === maxRetries - 1) throw error;
                        const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                throw new Error("API è«‹æ±‚å¤±æ•—æ¬¡æ•¸éå¤šã€‚");
            };

            const generateSuggestion = async (day, index) => {
                if (!geminiApiKey) {
                    // æç¤ºç”¨æˆ¶è¨­å®š API Key (ä½†å› ç‚ºæŒ‰éˆ•è¢« disabled äº†ï¼Œé€™è£¡ä¸»è¦æ˜¯é˜²æ­¢æ„å¤–)
                    alert("è«‹è¨­å®š Gemini API Key ä»¥å•Ÿç”¨å»ºè­°åŠŸèƒ½ã€‚");
                    return;
                }

                isGenerating.value = true;
                isSuggestionModalOpen.value = false;
                suggestionResult.value = { text: '', sources: [] };
                
                const dayData = itinerary.value.find(d => d.day === day);
                const item = dayData.schedule[index];
                generatingItemName.value = item.item;

                isSuggestionModalOpen.value = true;
                suggestionResult.value.text = ''; // æ¸…ç©ºèˆŠçµæœ

                // ç³»çµ±æç¤ºè©ï¼šè¨­å®šæ¨¡å‹çš„è§’è‰²ã€èªè¨€å’Œæ ¼å¼
                const systemPrompt = "You are a local travel expert in the Jiangsu and Zhejiang region (Suzhou, Hangzhou, Wuzhen, Shanghai). Your task is to provide three high-quality, actionable alternative suggestions or backup plans for a given itinerary item. The suggestions must be appropriate for a Chinese New Year (CNY) trip and consider the crowd warnings and weather provided. Respond concisely in Traditional Chinese, strictly as a bulleted list (use Markdown format: '*' for list items). Do not include an introduction, conclusion, or any extra text outside the bulleted list.";
                
                // ç”¨æˆ¶æŸ¥è©¢ï¼šæä¾›æ‰€æœ‰å¿…è¦çš„ä¸Šä¸‹æ–‡è³‡è¨Š
                const userQuery = `Current City: ${dayData.city}, Date: ${dayData.date}, Weather: ${dayData.weather}, CNY Warning: ${dayData.cnyWarning}. The original planned activity is: ${item.item} (${item.detail}). Generate 3 alternative suggestions for this specific time slot.`;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${geminiApiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    // å•Ÿç”¨ Google æœå°‹ä»¥æä¾›å¯¦æ™‚å’Œæœ¬åœ°åŒ–è³‡è¨Š
                    tools: [{ "google_search": {} }], 
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                try {
                    const response = await exponentialBackoffFetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result && result.candidates && result.candidates.length > 0) {
                        const candidate = result.candidates[0];
                        const text = candidate.content?.parts?.[0]?.text || 'æœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„å»ºè­°ã€‚';
                        suggestionResult.value.text = text;

                        // æå–å¼•ç”¨ä¾†æº
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                        suggestionResult.value.sources = sources;
                    } else {
                        suggestionResult.value.text = 'æœªèƒ½ç²å¾—æœ‰æ•ˆçš„ç”Ÿæˆçµæœï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ–ç¨å¾Œå†è©¦ã€‚';
                    }

                } catch (error) {
                    console.error("Error fetching Gemini content:", error);
                    suggestionResult.value.text = `API è«‹æ±‚å¤±æ•—ï¼Œç„¡æ³•å–å¾—å»ºè­°ï¼š${error.message}`;
                } finally {
                    isGenerating.value = false;
                }
            };
            // ===============================================

            return {
                currentDate,
                itinerary,
                currentDay,
                isLoading,
                isModalOpen,
                editingItem,
                isSuggestionModalOpen, 
                suggestionResult,      
                isGenerating,          
                generatingItemName,    
                isGuideModalOpen,      
                guideSummary,          
                setCurrentDate,
                openAddItemModal,
                editItem,
                saveItem,
                deleteItem,
                openMap,
                getWeatherIcon,
                getScheduleIcon,
                formatCost,
                generateSuggestion,    
                renderMarkdown,
                geminiApiKey         
            };
        }
    }).mount('#app');
</script>

</body>

</html>
